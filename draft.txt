<APARTMENT ID="45372" OBJECTID="1548579" OBJECTGUID="06207a19-dc13-4dd2-8cd7-d83bc33e7478" CHANGEID="4195933" NUMBER="1"
APARTTYPE="2" OPERTYPEID="10" PREVID="0" NEXTID="45380" UPDATEDATE="2019-11-23" STARTDATE="2016-08-12" ENDDATE="2016-08-12"
ISACTUAL="0" ISACTIVE="0" />

<APARTMENT ID="45380" OBJECTID="1548579" OBJECTGUID="06207a19-dc13-4dd2-8cd7-d83bc33e7478" CHANGEID="4195953" NUMBER="1"
APARTTYPE="2" OPERTYPEID="31" PREVID="45372" NEXTID="0" UPDATEDATE="2018-08-17" STARTDATE="2016-08-12" ENDDATE="2016-08-12"
ISACTUAL="1" ISACTIVE="0" />





drop schema fias cascade



DELETE FROM fias.adm_hierarchy
WHERE region_code = 64
AND adm_h_id IN (
    SELECT adm_h_id FROM (
        SELECT adm_h_id, object_id, adm_h_end_date, row_number() OVER (PARTITION BY object_id ORDER BY adm_h_end_date DESC)
        FROM fias.adm_hierarchy
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.adm_hierarchy
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt > 1
        )
    ) AS f2 WHERE row_number > 1
)

select count(distinct object_id) from fias.adm_hierarchy
select count(*) from fias.adm_hierarchy

DELETE FROM fias.addr_objects
WHERE region_code = 64
AND addr_obj_id IN (
    SELECT addr_obj_id FROM (
        SELECT addr_obj_id, object_id, addr_obj_end_date, RANK() OVER (PARTITION BY object_id ORDER BY addr_obj_end_date DESC)
        FROM fias.addr_objects
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.addr_objects
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt > 1
        )
    ) AS f2 WHERE rank > 1
)


DELETE FROM fias.houses
WHERE region_code = 64
AND house_id IN (
    SELECT house_id FROM (
        SELECT house_id, object_id, house_end_date, RANK() OVER (PARTITION BY object_id ORDER BY house_end_date DESC)
        FROM fias.houses
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.houses
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt > 1
        )
    ) AS f2 WHERE rank > 1
)


DELETE FROM fias.apartments
WHERE region_code = 64
AND apartment_id IN (
    SELECT apartment_id FROM (
        SELECT apartment_id, object_id, apart_end_date, RANK() OVER (PARTITION BY object_id ORDER BY apart_end_date DESC)
        FROM fias.apartments
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.apartments
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt > 1
        )
    ) AS f2 WHERE rank > 1
)

select count(distinct object_id) from fias.apartments
select count(*) from fias.apartments









drop schema fias cascade

DELETE FROM fias.adm_hierarchy
WHERE region_code = 64
AND adm_h_id IN (
    SELECT object_id FROM (
        SELECT adm_h_id, object_id, adm_h_end_date, ROW_NUMBER() OVER (PARTITION BY object_id ORDER BY adm_h_end_date DESC)
        FROM fias.adm_hierarchy
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.adm_hierarchy
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt > 1
        )
    ) AS f2 WHERE ROW_NUMBER > 1
)

select distinct object_id from fias.adm_hierarchy
union all
select count(*) from fias.adm_hierarchy


DELETE FROM fias.apartments
WHERE region_code = 64
AND apartment_id IN (
    SELECT apartment_id FROM (
        SELECT apartment_id, object_id, apart_end_date, ROW_NUMBER() OVER (PARTITION BY object_id ORDER BY apart_end_date DESC)
        FROM fias.apartments
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.apartments
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt > 1
        )
    ) AS f2 WHERE ROW_NUMBER > 1
)

select count(distinct object_id) from fias.apartments
select count(*) from fias.apartments


select * from (
    SELECT object_id FROM (
        SELECT adm_h_id, object_id, adm_h_end_date, ROW_NUMBER() OVER (PARTITION BY object_id ORDER BY adm_h_end_date DESC)
        FROM fias.adm_hierarchy
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.adm_hierarchy
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt > 1
        )
    ) AS f2 WHERE ROW_NUMBER > 1
  union all
    select distinct object_id from fias.adm_hierarchy

) as f1
except
select distinct object_id from fias.adm_hierarchy








-- first select rows number should be equal to second select row numbers
-- 23.04.23 колво записей совпадает

select count(distinct object_id) from fias.addr_objects;

SELECT addr_obj_id FROM (
    SELECT addr_obj_id, object_id, addr_obj_end_date, ROW_NUMBER() OVER (PARTITION BY object_id ORDER BY addr_obj_end_date DESC)
    FROM fias.addr_objects
    WHERE region_code = 64
    AND object_id IN (
        SELECT object_id FROM (
            SELECT object_id, COUNT(*) AS cnt
            FROM fias.addr_objects
            WHERE region_code = 64
            GROUP BY 1
        ) AS f1 WHERE cnt >= 1
    )
) AS f2 WHERE ROW_NUMBER = 1


select count(distinct object_id) from fias.adm_hierarchy

DELETE FROM fias.adm_hierarchy
WHERE region_code = 64
AND adm_h_id IN (
    SELECT adm_h_id FROM (
        SELECT adm_h_id, object_id, adm_h_end_date, row_number() OVER (PARTITION BY object_id ORDER BY adm_h_end_date DESC)
        FROM fias.adm_hierarchy
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.adm_hierarchy
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt >= 1
        )
    ) AS f2 WHERE row_number = 1
)

select count(distinct object_id) from fias.houses

DELETE FROM fias.houses
WHERE region_code = 64
AND house_id IN (
    SELECT house_id FROM (
        SELECT house_id, object_id, house_end_date, row_number() OVER (PARTITION BY object_id ORDER BY house_end_date DESC)
        FROM fias.houses
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.houses
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt >= 1
        )
    ) AS f2 WHERE row_number = 1
)


select count(distinct object_id) from fias.apartments

WHERE region_code = 64
AND apartment_id IN (
    SELECT apartment_id FROM (
        SELECT apartment_id, object_id, apart_end_date, row_number() OVER (PARTITION BY object_id ORDER BY apart_end_date DESC)
        FROM fias.apartments
        WHERE region_code = 64
        AND object_id IN (
            SELECT object_id FROM (
                SELECT object_id, COUNT(*) AS cnt
                FROM fias.apartments
                WHERE region_code = 64
                GROUP BY 1
            ) AS f1 WHERE cnt >= 1
        )
    ) AS f2 WHERE row_number = 1
)